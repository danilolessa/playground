function getURLParameter(o) {
  return decodeURI((RegExp(o + "=(.+?)(&|$)").exec(location.search) || [, null])[1])
}

function log(o) {
  setTimeout(function() {
    throw new Error(o)
  }, 0)
}

function createMap() {
  map = new google.maps.Map(document.getElementById("mapa"), {
    center: new google.maps.LatLng(-23.544, -46.643),
    zoom: 9,
    zoom_changed: function() {
      mapZoomChanged()
    },
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    mapTypeControlOptions: {
      style: google.maps.MapTypeControlStyle.DEFAULT,
      position: google.maps.ControlPosition.TOP_RIGHT
    },
    styles: [{
      featureType: "transit.station.bus",
      stylers: [{
        visibility: "off"
      }]
    }]
  })
}

function mapZoomChanged() {
  if (map.getZoom() < 15)
    for (var o in pontos) pontos[o].setVisible(!1);
  else if (linhaExibida > 0)
    for (var o in pontos) pontos[o].rota.id == rotaExibida && pontos[o].setVisible(!0)
}

function tratar(o) {
  return null == o || void 0 == o ? "" : o
}

function closeInfow() {
  null != infow && (infow.set("marker", null), infow.close())
}

function atualizaPan() {
  var o = !1,
    i = new google.maps.LatLngBounds;
  for (var t in pontos) pontos[t].linha == linhaExibida && (i.extend(pontos[t].position), o = !0);
  o && map.fitBounds(i)
}

function limpaVeiculos() {
  for (var o in veiculos) veiculos[o].setMap(null);
  veiculos = []
}

function limpaPontos() {
  for (var o in pontos) pontos[o].setMap(null);
  pontos = []
}

function limpaTrajetos() {
  for (var o in trajetos) trajetos[o].setMap(null);
  trajetos = []
}

function limpaMapa() {
  closeInfow(), rotaExibida = 0;
  for (var o in pontos) pontos[o].setVisible(!1);
  for (var o in trajetos) trajetos[o].setVisible(!1);
  for (var o in veiculos) veiculos[o].setVisible(!1)
}

function showTrajeto(o) {
  for (var i in trajetosSombra) trajetosSombra[i].rota.id == o && trajetosSombra[i].setVisible(!0)
}

function hideTrajeto(o) {
  for (var i in trajetosSombra) trajetosSombra[i].rota.id == o && trajetosSombra[i].setVisible(!1)
}

function comparar(o, i) {
  return o === i || o === i + "A" || o === i + "H"
}

function loadLinha(o, i) {
  if (o.length > 0)
    for (var t in o)
      if (comparar(o[t].codigo, i)) {
        var a = $("<table>").appendTo($("#lista_rotas")),
          e = o[t].rotas;
        for (var n in e) {
          var s = google.maps.geometry.encoding.decodePath(e[n].encode),
            r = new google.maps.Polyline({
              path: s,
              strokeColor: "#18357b",
              strokeOpacity: 1,
              strokeWeight: 2,
              map: map,
              linha: o[t].codigo,
              rota: e[n],
              visible: !1,
              icons: [{
                icon: {
                  path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW
                },
                offset: "100%",
                repeat: "20%"
              }]
            });
          trajetos[e[n].id] = r;
          var l = new google.maps.Polyline({
            path: s,
            strokeColor: "#228B22",
            strokeOpacity: .6,
            strokeWeight: 4,
            map: map,
            linha: o[t].codigo,
            rota: e[n],
            visible: !1
          });
          trajetosSombra[e[n].id] = l;
          var d = $("<tr>").append($("<td>").append($("<img src='" + iconVeiculoIda + "' title='" + o[t].codigo + "'>"))).append($("<td>").addClass("codigoRota").css("vertical-align", "top").text("para " + e[n].destino)).append($("<td>").addClass("ui-icon ui-icon-triangle-1-s").css("vertical-align", "middle")).data("rota", e[n].id).data("linha", o[t].codigo);
          d.hover(function() {
            trajetosSombra[$(this).data("rota")].setVisible(!0)
          }, function() {
            trajetosSombra[$(this).data("rota")].setVisible(!1)
          }), d.click(function() {
            $(this).data("rota") != rotaExibida && ($(".codigoRotaOn").removeClass("codigoRotaOn"), $(this).addClass("codigoRotaOn"), showRota($(this).data("rota")), linhaExibida = $(this).data("linha"), refreshVeiculos()), $("#paradas" + $(this).data("rota")).slideToggle("slow"), $(this).children(".ui-icon").toggleClass("ui-icon-triangle-1-s").toggleClass("ui-icon-triangle-1-n")
          }), a.append(d);
          var p = $("<ul>");
          for (var c in e[n].pontos) {
            var u = $("<li>").addClass("parada").text(e[n].pontos[c].endereco);
            u.data("ponto", e[n].pontos[c]), u.data("rota", e[n]), u.click(function() {
              var o = $(this).data("ponto");
              map.setZoom(18), map.panTo(new google.maps.LatLng(o.latitude, o.longitude))
            }), p.append(u)
          }
          var g = $("<div>").append(p).attr("id", "paradas" + e[n].id).addClass("paradas");
          g.hide(), a.append($("<tr>").append($("<td>").css("border-top-style", "dotted").css("border-width", "1px").css("border-color", "gray").prop("colspan", "3").append(g))), loadPontos(e[n].pontos, e[n], o[t].codigo)
        }
        loadVeiculos(o[t].veiculos), linhaExibida = o[t].codigo, atualizaPan()
      }
}

function showRota(o) {
  limpaMapa(), rotaExibida = o;
  for (var i in veiculos) veiculos[i].rota == o && veiculos[i].setVisible(!0);
  trajetos[o].setVisible(!0), atualizaPan()
}

function busTimer() {
  "" != linhaExibida && refreshVeiculos()
}

function refreshVeiculos() {
  $("#status").show(), $.ajax({
    url: serviceUrl + "linha=" + linhaExibida,
    type: "GET"
  }).done(function(o) {
    "string" == typeof o && (o = jQuery.parseJSON(o)), limpaVeiculos();
    var i = o.linhas;
    for (var t in i) i[t].codigo == linhaExibida && loadVeiculos(i[t].veiculos);
    $("#status").hide()
  })
}

function loadVeiculos(o) {
  for (var i in o) {
    var t = o[i],
      a = !1;
    rotaExibida == t.idRota && (a = !0);
    var e = new google.maps.LatLng(t.latitude, t.longitude),
      n = new google.maps.LatLng(trajetos[t.idRota].rota.pontos[trajetos[t.idRota].rota.pontos.length - 1].latitude, trajetos[t.idRota].rota.pontos[trajetos[t.idRota].rota.pontos.length - 1].longitude),
      s = google.maps.geometry.spherical.computeHeading(e, n),
      r = "<div class='infowindow'><div><p>Empresa:&nbsp;</p>" + t.consorcio + "</div><div><p>Prefixo:&nbsp;</p>" + t.prefixo + "</div><div><p>Linha:&nbsp;</p>" + t.codigoLinha + "</div><div><p>Destino:&nbsp;</p>" + trajetos[t.idRota].rota.destino + "</div><div><p>&Uacute;ltima Atualiza&ccedil;&atilde;o:&nbsp;</p>" + getDateTime(new Date(t.dataUltimaTransmissao)) + "</div></div>",
      l = new MarkerWithLabel({
        position: e,
        map: map,
        icon: s > 0 ? iconVeiculoIda : iconVeiculoVolta,
        rota: t.idRota,
        veiculo: t,
        tipo: "veiculo",
        visible: a,
        labelContent: t.prefixo,
        labelAnchor: new google.maps.Point(22, 37),
        labelClass: "labels",
        labelStyle: {
          opacity: .75
        }
      });
    veiculos.push(l), bindInfoW(l, r)
  }
}

function loadPontos(o, i, t) {
  for (var a in o) {
    var e = o[a],
      n = new google.maps.LatLng(e.latitude, e.longitude),
      s = new google.maps.Marker({
        position: n,
        map: map,
        icon: iconPonto,
        rota: i,
        linha: t,
        ponto: e,
        seq: parseInt(a) + 1,
        tipo: "ponto",
        visible: !1
      });
    pontos[e.id] = s, bindPointInfoW(s)
  }
}

function bindPointInfoW(o) {
  google.maps.event.addListener(o, "click", function() {
    closeInfow();
    var i = "<div class='infowindow'><div><p>Linha:&nbsp;</p>" + this.rota.codigoLinha + " " + this.rota.sentido + "</div><div><p>Destino:&nbsp;</p>" + this.rota.destino + "</div><div><p>Endere&ccedil;o:&nbsp;</p>" + this.ponto.endereco + "</div>",
      t = [],
      a = [];
    for (var e in veiculos) {
      var n = veiculos[e];
      if (n.visible && n.rota == this.rota.id) {
        var s, r = Number.MAX_VALUE;
        for (var l in pontos) {
          var d = Math.round(google.maps.geometry.spherical.computeDistanceBetween(n.position, pontos[l].position));
          r > d && (r = d, s = pontos[l])
        }
        if (s.seq < this.seq) {
          var p = "",
            d = Math.round(google.maps.geometry.spherical.computeDistanceBetween(n.position, this.position));
          p = d > 999 ? "<div>Ve&iacute;culo&nbsp;" + n.veiculo.prefixo + "&nbsp;a&nbsp;aproximadamente&nbsp;" + Math.round(d / 1e3) + "km</div>" : "<div>Ve&iacute;culo&nbsp;" + n.veiculo.prefixo + "&nbsp;a&nbsp;aproximadamente&nbsp;" + d + "m</div>", t[d] = p, a.push(d)
        }
      }
    }
    var p = "";
    for (var e in a.sort(function(o, i) {
        return o - i
      })) p += t[a[e]];
    p.length > 0 && (i += "<div><p>&Ocirc;nibus&nbsp;em&nbsp;Opera&ccedil;&atilde;o:</p></div><br>", i += p), i += "</div>";
    var c = new InfoBubble({
      maxWidth: "400px",
      backgroundColor: "#F6F4F0",
      disableAutoPan: !0,
      minHeight: "300px"
    });
    c.setContent(i), c.open(map, o), infow = c
  })
}

function bindInfoW(o, i) {
  google.maps.event.addListener(o, "click", function() {
    closeInfow();
    var t = new InfoBubble({
      maxWidth: "400px",
      backgroundColor: "#F6F4F0",
      disableAutoPan: !0,
      minHeight: "300px"
    });
    t.setContent(i), t.open(map, o), infow = t
  })
}

function getDateTime(o) {
  var i = function(o, i) {
    return (1e15 + o + "").slice(-i)
  };
  return ("undefined" == typeof o || null == o) && (o = new Date), i(o.getDate(), 2) + "/" + i(o.getMonth() + 1, 2) + "/" + o.getFullYear() + " " + i(o.getHours(), 2) + ":" + i(o.getMinutes(), 2) + ":" + i(o.getSeconds(), 2)
}

function htmlEncode(o) {
  return $("<div/>").text(o).html()
}

function htmlDecode(o) {
  return $("<div/>").html(o).text()
}
var map, serviceUrl = "/bustime?",
  iconPonto = "/img/parada.png",
  iconVeiculoIda = "/img/onibus-ida.png",
  iconVeiculoVolta = "/img/onibus-volta.png",
  trajetos = [],
  trajetosSombra = [],
  pontos = [],
  veiculos = [],
  infow, infows = [],
  linhaExibida = 0,
  rotaExibida = 0;
$(document).ready(function() {
  $("#status").show(), createMap();
  var o = getURLParameter("linha");
  null != o && "null" != o && "" != o && $.ajax({
    url: serviceUrl + "linha=" + o,
    type: "GET"
  }).done(function(i) {
    "string" == typeof i && (i = jQuery.parseJSON(i));
    var t = i.linhas;
    loadLinha(t, o), $("#status").hide(), $("#pontos").show("slide", {
      direction: "right"
    }), $("#show_pontos").hide("slide", {
      direction: "right"
    })
  }), $("#hide_pontos").click(function() {
    $("#pontos").hide("slide", {
      direction: "right"
    }), $("#show_pontos").show("slide", {
      direction: "right"
    })
  }), $("#show_pontos").click(function() {
    $("#pontos").show("slide", {
      direction: "right"
    }), $("#show_pontos").hide("slide", {
      direction: "right"
    })
  }), $("#dialog-message").dialog({
    modal: !0,
    buttons: {
      Ok: function() {
        $(this).dialog("close")
      }
    },
    width: 500,
    resizable: !1,
    draggable: !1
  }), $("#status").hide(), $("#municipios").tooltip(), $.ajaxSetup({
    cache: !1
  });
  setInterval(function() {
    busTimer()
  }, 3e4)
});
